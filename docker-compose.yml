# ============================================================================
# DOCKER COMPOSE - Local Development Environment
# ============================================================================
# PURPOSE: Run backend (FastAPI) + frontend (Streamlit) locally
# USAGE: docker-compose up
# NOTES: Mirrors Cloud Run setup for consistent development experience
# ============================================================================

version: '3.8'

services:
  # ===========================
  # Backend Service (FastAPI)
  # ===========================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.backend
    container_name: realestate-backend
    ports:
      - "8080:8080"
    environment:
      PYTHONUNBUFFERED: "1"
      GCS_BUCKET_NAME: "${GCS_BUCKET_NAME:-local-models}"
      GCS_MODEL_PATH: "${GCS_MODEL_PATH:-models/latest}"
      GROQ_API_KEY: "${GROQ_API_KEY:-dummy}"
      LOG_LEVEL: "${LOG_LEVEL:-INFO}"
    volumes:
      # Local development: hot reload & live code updates
      - ./backend/src:/app/src
      # Local models for running without GCS
      - ./backend/models:/app/models
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - realestate-network
    restart: unless-stopped

  # ===========================
  # Frontend Service (Streamlit)
  # ===========================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.frontend
    container_name: realestate-frontend
    ports:
      - "8501:8501"
    environment:
      PYTHONUNBUFFERED: "1"
      BACKEND_API_URL: "http://backend:8080"
      LOG_LEVEL: "${LOG_LEVEL:-INFO}"
    volumes:
      # Hot reload for Streamlit
      - ./frontend/app:/app/app
    depends_on:
      - backend
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - realestate-network
    restart: unless-stopped

# ===========================
# Networks
# ===========================
networks:
  realestate-network:
    driver: bridge

# ============================================================================
# HOW TO USE
# ============================================================================

# Start everything:
#     docker-compose up
#
# Start in background:
#     docker-compose up -d
#
# Restart:
#     docker-compose restart
#
# View logs:
#     docker-compose logs -f
#
# Rebuild only backend:
#     docker-compose build backend
#
# Rebuild everything:
#     docker-compose build --no-cache
#
# Stop:
#     docker-compose down
#
# App URLs:
#     Frontend: http://localhost:8501
#     Backend:  http://localhost:8080
#     Docs:     http://localhost:8080/docs
